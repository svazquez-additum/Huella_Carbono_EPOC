<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Huella Carbono EPOC</title>
    <style>
        /* =========================================
           ESTILOS CSS
           ========================================= */
        :root {
            --azul-muy-oscuro: #00204A; /* Barra Diag */
            --azul-oscuro: #004B87;     /* Barra Trat */
            --azul-medio: #0074D9;      /* Barra Seg */
            --azul-claro-medio: #408EC6;/* Barra Ing */
            --azul-fondo: #E6F0FA;
            --blanco: #FFFFFF;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--blanco);
            color: #333;
            margin: 0;
            padding: 20px;
        }

        /* CABECERA */
        .header {
            display: flex;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--azul-oscuro);
            margin-bottom: 20px;
        }

        .header-logos {
            flex: 0 0 150px;
            margin-right: 20px;
        }

        .header-logos img {
            width: 100%;
            max-width: 140px;
            display: block;
        }

        .header-title h1 {
            color: var(--azul-muy-oscuro);
            margin: 0;
            font-size: 2rem;
        }

        .header-title p {
            margin: 5px 0 0 0;
            font-size: 1.1rem;
            color: var(--azul-oscuro);
        }

        /* PESTA√ëAS */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--azul-oscuro);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            color: #555;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button:hover {
            background-color: var(--azul-fondo);
        }

        .tab-button.active {
            color: var(--azul-oscuro);
            border-bottom: 3px solid var(--azul-oscuro);
        }
        .tab-button.disabled { opacity: 0.5; cursor: not-allowed; }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ESTRUCTURA */
        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .col {
            flex: 1;
            min-width: 300px;
        }

        /* GRID 2x2 PARA RESULTADOS */
        .grid-2x2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* INPUTS */
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--azul-oscuro);
        }

        select, input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: var(--blanco);
            color: #000;
            font-weight: bold;
            box-sizing: border-box;
            font-size: 1rem;
        }

        /* Estilo para Radio Buttons mejorado */
        .radio-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        input[type="radio"] {
            transform: scale(1.2);
            margin-right: 8px;
            cursor: pointer;
        }

        .input-group {
            margin-bottom: 15px;
        }

        /* CAJAS ESTILIZADAS */
        .caja-azul {
            background-color: var(--azul-fondo);
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid var(--azul-oscuro);
            margin-top: 15px;
        }

        .caja-transporte {
            border: 1px solid #dcebf7;
            padding: 15px;
            border-radius: 8px;
            background-color: #F9FCFF;
            margin-top: 10px;
        }
        
        /* Caja espec√≠fica para cada consulta din√°mica */
        .bloque-consulta {
            background-color: #fff;
            border: 1px solid #b3d7ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .fila-dinamica {
            background-color: #f8f9fa;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .resultado-parcial {
            text-align: right;
            color: var(--azul-oscuro);
            font-weight: bold;
            margin-top: 10px;
        }

        .titulo-seccion {
            color: var(--azul-muy-oscuro);
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        /* TARJETAS DE RESULTADOS */
        .metric-card {
            background-color: var(--blanco);
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .metric-label {
            color: #666;
            font-size: 1rem;
            margin-top: 5px;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }

        /* CAJA TOTAL FINAL */
        .total-box {
            background-color: var(--azul-muy-oscuro);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
        }

        .btn-download {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: var(--azul-oscuro);
            color: white;
            text-align: center;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
        }
        
        .btn-download:hover { background-color: var(--azul-muy-oscuro); }

        /* Small button variant for inline actions */
        .btn-small {
            padding: 8px 10px;
            background: var(--azul-oscuro);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
        }
        .btn-small:hover { opacity: 0.95; }
        .btn-small.btn-danger { background: #FF6B6B; }

        /* GR√ÅFICO DE BARRAS */
        .chart-container {
            height: 300px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            padding: 20px;
            border-left: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
            margin-top: 20px;
            background-color: #fafafa;
        }

        .bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 18%;
            height: 100%;
            justify-content: flex-end;
        }

        .bar {
            width: 100%;
            transition: height 0.6s ease-out;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            min-height: 2px;
            position: relative;
        }
        
        #bar_diag { background-color: var(--azul-muy-oscuro); }
        #bar_trat { background-color: var(--azul-oscuro); }
        #bar_seg  { background-color: var(--azul-medio); }
        #bar_ing  { background-color: var(--azul-claro-medio); }

        .bar:hover { opacity: 0.85; }

        .bar-label {
            margin-top: 10px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .bar-value {
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
            color: #333;
        }

        .hidden { display: none; }

        /* Result table styling */
        #res_breakdown th { text-align:left; color:var(--azul-muy-oscuro); }
        #res_breakdown td { border-bottom: 1px solid #f0f5fb; padding:8px; }
        #res_breakdown tr:last-child td { border-bottom: none; }
        #res_csv_filename { font-weight: 700; }
    </style>
</head>
<body>

    <!-- CABECERA -->
    <div class="header">
        <div class="header-logos">
            <!-- Si no encuentra la imagen, muestra texto -->
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAV8AAABuCAYAAACA5BA9AAABN2lDQ1BBZG9iZSBSR0IgKDE5OTgpAAAokZWPv0rDUBSHvxtFxaFWCOLgcCdRUGzVwYxJW4ogWKtDkq1JQ5ViEm6uf/oQjm4dXNx9AidHwUHxCXwDxamDQ4QMBYvf9J3fORzOAaNi152GUYbzWKt205Gu58vZF2aYAoBOmKV2q3UAECdxxBjf7wiA10277jTG+38yH6ZKAyNguxtlIYgK0L/SqQYxBMygn2oQD4CpTto1EE9AqZf7G1AKcv8ASsr1fBBfgNlzPR+MOcAMcl8BTB1da4Bakg7UWe9Uy6plWdLuJkEkjweZjs4zuR+HiUoT1dFRF8jvA2AxH2w3HblWtay99X/+PRHX82Vun0cIQCw9F1lBeKEuf1UYO5PrYsdwGQ7vYXpUZLs3cLcBC7dFtlqF8hY8Dn8AwMZP/fNTP8gAAAAJcEhZcwAACxMAAAsTAQCanBgAAAXqaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MiA3OS4xNjA5MjQsIDIwMTcvMDcvMTMtMDE6MDY6MzkgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIiB4bWxuczpwaG90b3Nob3A9Imh0dHA6Ly9ucy5hZG9iZS5jb20vcGhvdG9zaG9wLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDIyLTAyLTIzVDAyOjI0OjQ0KzAxOjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAyMi0wOS0yN1QxNjo1MjowMiswMjowMCIgeG1wOk1ldGFkYXRhRGF0ZT0iMjAyMi0wOS0yN1QxNjo1MjowMiswMjowMCIgZGM6Zm9ybWF0PSJpbWFnZS9wbmciIHBob3Rvc2hvcDpDb2xvck1vZGU9IjMiIHBob3Rvc2hvcDpJQ0NQcm9maWxlPSJBZG9iZSBSR0IgKDE5OTgpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjMyODU2ZTZkLWUwYjgtNjc0MC1hY2UzLWFmZTE0OGIxOWViOCIgeG1wTU06RG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjA5ZDgzMjM2LWEwYmItMmU0Zi05NDEzLWZhY2U5YjUzZTg0ZCIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOjQ1ZjQ4ZmNmLWE5M2UtMmE0Yi1hNTY4LTAwNDZjZWMzOTlhYSI+IDx4bXBNTTpIaXN0b3J5PiA8cmRmOlNlcT4gPHJkZjpsaSBzdEV2dDphY3Rpb249ImNyZWF0ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6NDVmNDhmY2YtYTkzZS0yYTRiLWE1NjgtMDA0NmNlYzM5OWFhIiBzdEV2dDp3aGVuPSIyMDIyLTAyLTIzVDAyOjI0OjQ0KzAxOjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgQ0MgKFdpbmRvd3MpIi8+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJzYXZlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDozMjg1NmU2ZC1lMGI4LTY3NDAtYWNlMy1hZmUxNDhiMTllYjgiIHN0RXZ0OndoZW49IjIwMjItMDktMjdUMTY6NTI6MDIrMDI6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCBDQyAoV2luZG93cykiIHN0RXZ0OmNoYW5n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" alt="Logo Additum" onerror="this.style.display='none'; document.getElementById('alt-text').style.display='block'">
            <div id="alt-text" style="display:none; font-weight:bold; font-size:1.5rem; color:var(--azul-muy-oscuro);">ADDITUM</div>
        </div>
        <div class="header-title">
            <h1>Calculadora Huella Carbono EPOC</h1>
            <p>An√°lisis del impacto ambiental del proceso asistencial</p>
        </div>
    </div>

    <!-- PESTA√ëAS -->
    <div class="tabs">
        <button id="tab_button_info" class="tab-button active" onclick="openTab('info', this)">1. Info. General</button>
        <button id="tab_button_diag" class="tab-button" onclick="openTab('diag', this)">2. Diagn√≥stico</button>
        <button id="tab_button_trat" class="tab-button" onclick="openTab('trat', this)">3. Tratamiento</button>
        <button id="tab_button_seg" class="tab-button" onclick="openTab('seg', this)">4. Seguimiento</button>
        <button id="tab_button_ing" class="tab-button" onclick="openTab('ing', this)">5. Ingresos</button>
        <button id="tab_button_res" class="tab-button" onclick="openTab('res', this)">üìä Resultados</button>
    </div>

    <!-- =========================================
         PESTA√ëA 1: INFO GENERAL
         ========================================= -->
    <div id="info" class="tab-content active">
        <h2 class="titulo-seccion">Info. General</h2>
        <div class="caja-azul">
            <div class="row">
                <div class="col">
                    <label>Nombre</label>
                    <input type="text" id="info_first_name" placeholder="Nombre" oninput="updateInfo()">
                </div>
                <div class="col">
                    <label>Apellidos</label>
                    <input type="text" id="info_last_name" placeholder="Apellidos" oninput="updateInfo()">
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label>Fecha de nacimiento</label>
                    <input type="date" id="info_dob" onchange="updateInfo()">
                    <div id="info_dob_age" style="font-size:0.9rem; color:#666; margin-top:4px;">Edad: ‚Äî</div>
                </div>
                <div class="col">
                    <label>Centro Sanitario</label>
                    <select id="info_center" onchange="updateInfo()">
                        <option value="Centro de Salud 1">Centro de Salud 1</option>
                        <option value="Centro de Salud 2">Centro de Salud 2</option>
                    </select>
                </div>
                <div class="col">
                    <label>Fecha Diagn√≥stico inicial</label>
                    <input type="date" id="info_diag_date" onchange="updateInfo()">
                    <div id="info_diag_duration" style="font-weight:bold; color:var(--azul-oscuro);">‚Äî</div>
                </div>
            </div>
        </div>
        <div class="row" style="margin-top:12px;">
            <div class="col">
                <div class="metric-card">
                    <h4 style="margin:0;">Resumen Paciente</h4>
                    <div id="info_summary" style="margin-top:10px; color:#333;">
                        <div id="info_summary_name">Nombre: ‚Äî</div>
                        <div id="info_summary_center">Centro: ‚Äî</div>
                        <div id="info_summary_dob">Fecha Nac.: ‚Äî</div>
                        <div id="info_summary_diag">Fecha Diagn√≥stico: ‚Äî</div>
                        <div id="info_summary_duration" style="margin-top:6px; color:var(--azul-oscuro); font-weight:bold;">Tiempo desde diagn√≥stico: ‚Äî</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="info_diag_notice" class="hidden caja-transporte" style="margin-top:10px; color:orange;">
            ‚ö†Ô∏è El diagn√≥stico es anterior a un a√±o; la fase <strong>Diagn√≥stico</strong> no se incluy√≥ en el c√°lculo del √∫ltimo a√±o.
        </div>
    </div>

    <!-- =========================================
         PESTA√ëA 2: DIAGN√ìSTICO
         ========================================= -->
    <div id="diag" class="tab-content">
        <h2 class="titulo-seccion">Fase de Diagn√≥stico</h2>
        
        <div class="row">
            <div class="col">
                <h4>ü©∫ Actividad Cl√≠nica</h4>
                <ul>
                    <li>Consulta AP Est√°ndar: <strong>2.300 kg CO‚ÇÇe</strong></li>
                </ul>
                <div class="input-group" style="margin-top:8px;">
                    <label>¬øSe ha realizado Hemograma?</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="diag_hemograma" value="si" checked onchange="calcular()"> S√≠</label>
                        <label class="radio-option"><input type="radio" name="diag_hemograma" value="no" onchange="calcular()"> No</label>
                    </div>
                    <div id="res_hemograma" style="font-weight:bold; color:var(--azul-oscuro); margin-top:6px;">Impacto Hemograma: 2.416 kg</div>
                </div>
            </div>
            <div class="col">
                <h4>üå¨Ô∏è Espirometr√≠a Diagn√≥stica</h4>
                <div class="input-group">
                    <label>¬øSe realiz√≥ la Espirometr√≠a?</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="diag_espiro_done" value="si" checked onchange="toggleDiagEspirometria(); calcular()"> S√≠</label>
                        <label class="radio-option"><input type="radio" name="diag_espiro_done" value="no" onchange="toggleDiagEspirometria(); calcular()"> No</label>
                    </div>
                </div>
                <div id="diag_espiro_repeat_block">
                    <div class="input-group">
                        <label>¬øSe ha tenido que repetir la prueba?</label>
                        <div class="radio-group">
                            <label class="radio-option"><input type="radio" name="diag_rep" value="no" checked onchange="calcular()"> No</label>
                            <label class="radio-option"><input type="radio" name="diag_rep" value="si" onchange="calcular()"> S√≠</label>
                        </div>
                    </div>
                </div>
                <div id="res_espiro_diag" style="color:var(--azul-oscuro); font-weight:bold;">Impacto: 0.167 kg</div>
            </div>
        </div>

        <hr>

        <div class="caja-transporte">
            <h4>üöå Transporte Paciente (Ida y Vuelta)</h4>
            <div class="row">
                <div class="col">
                    <label>Medio de transporte</label>
                    <select id="diag_transp_tipo" onchange="calcular()">
                        <option value="0.144">Autom√≥vil ligero</option>
                        <option value="0.120">Motocicleta / ciclomotor</option>
                        <option value="0.049">Autob√∫s urbano</option>
                        <option value="0.033">Tren de cercan√≠as</option>
                        <option value="0.030">Metro</option>
                        <option value="0">Andando / A pie (0 emisiones)</option>
                    </select>
                </div>
                <div class="col">
                    <label>Km recorridos</label>
                    <input type="number" id="diag_transp_km" value="0" min="0" oninput="calcular()">
                </div>
            </div>

            <!-- RADIO BUTTONS ACOMPA√ëANTES -->
            <div class="input-group" style="margin-top:15px; padding-top:10px; border-top:1px dashed #ccc;">
                <label>¬øAcude con acompa√±antes?</label>
                <div class="radio-group">
                    <label class="radio-option"><input type="radio" name="diag_acomp_check" value="no" checked onchange="toggleAcomp('diag'); calcular()"> No</label>
                    <label class="radio-option"><input type="radio" name="diag_acomp_check" value="si" onchange="toggleAcomp('diag'); calcular()"> S√≠</label>
                </div>
            </div>

            <!-- PANEL DIN√ÅMICO ACOMPA√ëANTES -->
            <div id="diag_acomp_panel" class="hidden" style="margin-left: 10px; padding-left: 15px; border-left: 4px solid var(--azul-fondo);">
                <label>N¬∫ Acompa√±antes:</label>
                <input type="number" id="diag_acomp_num" value="1" min="1" max="10" style="width: 100px; margin-bottom:10px;" oninput="renderAcompInputs('diag'); calcular()">
                
                <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">Defina el transporte de cada acompa√±ante:</p>
                <div id="diag_acomp_dynamic_rows">
                    <!-- Filas din√°micas JS -->
                </div>
            </div>

            <div class="resultado-parcial" id="diag_transp_res">Impacto Transporte Total: 0.000 kg</div>
        </div>

        <div class="caja-azul">
            <h3>Total Fase Diagn√≥stico: <span id="total_diag_display">0.000</span> kg CO‚ÇÇe</h3>
        </div>
    </div>

    <!-- =========================================
         PESTA√ëA 2: TRATAMIENTO
         ========================================= -->
    <div id="trat" class="tab-content">
        <h2 class="titulo-seccion">Fase de Tratamiento</h2>
        <div class="caja-transporte" style="background-color: var(--azul-fondo);">
            <div class="row">
                <!-- Per-device family selector is available within each device row -->
                <div class="col">
                    <label>Dispositivos</label>
                    <div id="trat_devices_container"></div>
                    <button type="button" class="btn-small" onclick="addTratDevice()" style="margin-top:10px;">‚ûï A√±adir otro dispositivo</button>
                </div>
            </div>
        </div>
        <div class="caja-azul">
            <h3>Total Tratamiento: <span id="total_trat_display">0.000</span> kg CO‚ÇÇe</h3>
        </div>
    </div>

    <!-- =========================================
         PESTA√ëA 3: SEGUIMIENTO
         ========================================= -->
    <div id="seg" class="tab-content">
        <h2 class="titulo-seccion">Fase de Seguimiento</h2>
        
        <div class="row">
            <div class="col">
                <h4>ü©∫ Configuraci√≥n General</h4>
                <label>N√∫mero total de consultas anuales</label>
                <input type="number" id="seg_num_cons" value="2" min="1" max="20" onchange="renderSeguimientoInputs(); calcular()">
                <div style="margin-top:10px; font-size:0.9em; color:#666;">
                    Se generar√°n fichas de transporte abajo para cada consulta.
                </div>
            </div>
            <div class="col">
                <h4>üå¨Ô∏è Espirometr√≠a Control</h4>
                <div class="input-group">
                    <label>¬øSe ha realizado la Espirometr√≠a de control?</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="seg_espiro_done" value="si" checked onchange="toggleSegEspirometria(); calcular()"> S√≠</label>
                        <label class="radio-option"><input type="radio" name="seg_espiro_done" value="no" onchange="toggleSegEspirometria(); calcular()"> No</label>
                    </div>
                </div>
                <div id="seg_espiro_controls_block">
                <div class="input-group">
                    <label>¬øSe repiti√≥ la prueba?</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="seg_espiro_rep" value="no" checked onchange="calcular()"> No</label>
                        <label class="radio-option"><input type="radio" name="seg_espiro_rep" value="si" onchange="calcular()"> S√≠</label>
                    </div>
                </div>
                <div class="input-group">
                    <label>¬øSe realiza la espirometr√≠a en la misma consulta de seguimiento?</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="seg_misma_visita" value="si" checked onchange="toggleVisitaExtra(); calcular()"> S√≠</label>
                        <label class="radio-option"><input type="radio" name="seg_misma_visita" value="no" onchange="toggleVisitaExtra(); calcular()"> No</label>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <div id="seg_extra_block" class="caja-transporte hidden" style="border-color:orange; background-color:#fffbf0; margin-bottom: 20px;">
            <h4 style="color:orange">‚ö†Ô∏è Visita Extra Espirometr√≠a</h4>
            <p style="font-size:0.9rem">Al no coincidir con la consulta, se suma una visita cl√≠nica (2.3kg) y un desplazamiento adicional.</p>
            <div class="row">
                <div class="col">
                    <label>Transporte Visita Extra</label>
                    <select id="seg_extra_tipo" onchange="calcular()">
                        <option value="0.144">Autom√≥vil ligero</option>
                        <option value="0.120">Motocicleta / ciclomotor</option>
                        <option value="0.049">Autob√∫s urbano</option>
                        <option value="0.033">Tren de cercan√≠as</option>
                        <option value="0.030">Metro</option>
                        <option value="0">Andando / A pie</option>
                    </select>
                </div>
                <div class="col">
                    <label>Km desplazamiento extra:</label>
                    <input type="number" id="seg_extra_km" value="0" min="0" oninput="calcular()">
                </div>
            </div>
        </div>

        <hr>

        <h4>üöå Detalle de Transporte por Consulta</h4>
        <div id="seg_consultas_container">
            <!-- AQU√ç SE GENERAN DIN√ÅMICAMENTE LOS BLOQUES DE CONSULTA -->
        </div>

        <div class="caja-azul">
            <h3>Total Seguimiento: <span id="total_seg_display">0.000</span> kg CO‚ÇÇe</h3>
        </div>
    </div>

    <!-- =========================================
         PESTA√ëA 4: INGRESOS
         ========================================= -->
    <div id="ing" class="tab-content">
        <h2 class="titulo-seccion">Ingresos Hospitalarios (SAE)</h2>
        <div class="input-group">
            <label>¬øHa tenido ingresos este a√±o?</label>
            <div class="radio-group">
                <label class="radio-option"><input type="radio" name="ing_check" value="no" checked onchange="toggleIngreso(); calcular()"> No</label>
                <label class="radio-option"><input type="radio" name="ing_check" value="si" onchange="toggleIngreso(); calcular()"> S√≠</label>
            </div>
        </div>

        <div id="ing_dias_block" class="hidden">
            <label>Ingresos del a√±o</label>
            <div id="ing_dias_container" style="margin-top:10px;">
                <!-- Dynamic ingreso rows -> each row: D√≠as de estancia + eliminar -->
            </div>
            <button type="button" class="btn-small" onclick="addIngreso()" style="margin-top:8px;">‚ûï A√±adir ingreso</button>
            <p style="color:#666; margin-top:10px;">Factor: 117 kg CO‚ÇÇe / d√≠a</p>
        </div>

        <div class="caja-azul">
            <h3>Total Ingresos: <span id="total_ing_display">0.000</span> kg CO‚ÇÇe</h3>
        </div>
    </div>

    <!-- =========================================
         PESTA√ëA 5: RESULTADOS
         ========================================= -->
    <div id="res" class="tab-content">
        <h2 class="titulo-seccion">Informe de Sostenibilidad</h2>
        <!-- Patient summary duplicated here for easy export and visible context -->
        <div id="res_patient_summary" class="metric-card" style="margin-bottom:12px; text-align:left;">
            <strong>Paciente:</strong> <span id="res_pat_name">‚Äî</span><br>
            <strong>Fecha Nac.:</strong> <span id="res_pat_dob">‚Äî</span> &nbsp; <span id="res_pat_age" style="color:#666; font-weight:600;">Edad: ‚Äî</span><br>
            <strong>Centro:</strong> <span id="res_pat_center">‚Äî</span><br>
            <strong>Fecha Diagn√≥stico:</strong> <span id="res_pat_diag">‚Äî</span> &nbsp; <span id="res_pat_diag_duration" style="color:var(--azul-oscuro); font-weight:600;">‚Äî</span>
            <div style="margin-top:8px; color:#555; font-size:0.9rem;">Informe generado: <span id="res_report_time">‚Äî</span></div>
        </div>
        <!-- GRID 2x2 DE RESULTADOS -->
        <div class="grid-2x2">
            <div class="metric-card">
                <div class="metric-value" id="res_diag" style="color:var(--azul-muy-oscuro)">0.00</div>
                <div class="metric-label">Diagn√≥stico <span style="font-size:0.8rem; color:#666;">(kg CO‚ÇÇe)</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="res_trat" style="color:var(--azul-oscuro)">0.00</div>
                <div class="metric-label">Tratamiento <span style="font-size:0.8rem; color:#666;">(kg CO‚ÇÇe)</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="res_seg" style="color:var(--azul-medio)">0.00</div>
                <div class="metric-label">Seguimiento <span style="font-size:0.8rem; color:#666;">(kg CO‚ÇÇe)</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="res_ing" style="color:var(--azul-claro-medio)">0.00</div>
                <div class="metric-label">Ingresos <span style="font-size:0.8rem; color:#666;">(kg CO‚ÇÇe)</span></div>
            </div>
        </div>

        <div class="row">
            <div class="col" style="flex:2">
                <!-- Gr√°fico de Barras con 4 colores -->
                <div class="chart-container">
                    <div class="bar-group">
                        <div class="bar-value" id="g_val_diag">0</div>
                        <div class="bar" id="bar_diag" style="height: 1%;"></div>
                        <div class="bar-label">Diag</div>
                    </div>
                    <div class="bar-group">
                        <div class="bar-value" id="g_val_trat">0</div>
                        <div class="bar" id="bar_trat" style="height: 1%;"></div>
                        <div class="bar-label">Trat</div>
                    </div>
                    <div class="bar-group">
                        <div class="bar-value" id="g_val_seg">0</div>
                        <div class="bar" id="bar_seg" style="height: 1%;"></div>
                        <div class="bar-label">Seg</div>
                    </div>
                    <div class="bar-group">
                        <div class="bar-value" id="g_val_ing">0</div>
                        <div class="bar" id="bar_ing" style="height: 1%;"></div>
                        <div class="bar-label">Ing</div>
                    </div>
                </div>
            </div>
            
            <div class="col">
                <div class="total-box">
                    <h1 id="gran_total" style="color:white !important; font-size:3.5rem; margin:0;">0.00</h1>
                    <p style="color:#E6F0FA !important;">kg CO‚ÇÇe Totales</p>
                </div>
                <button class="btn-download" onclick="sendDataToSheet()">üíæ Guardar y Enviar a Google Sheets</button>
                <div style="margin-top:10px; font-size:0.9rem; color:#fff; text-align:center;">Archivo: <span id="res_csv_filename">‚Äî</span></div>
            </div>
        </div>

        <!-- Detailed breakdown table -->
        <div style="margin-top:20px;">
            <h3 class="titulo-seccion">Desglose detallado y porcentajes</h3>
            <div class="caja-azul">
                <table id="res_breakdown" style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="text-align:left; border-bottom:1px solid #e6f0fa;">
                            <th style="padding:8px; width:45%;">Fase</th>
                            <th style="padding:8px;">Impacto (kg CO‚ÇÇe)</th>
                            <th style="padding:8px;">% del total</th>
                            <th style="padding:8px;">Detalle</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding:8px; font-weight:600;">Diagn√≥stico</td>
                            <td id="break_diag" style="padding:8px;">0.00</td>
                            <td id="break_diag_pct" style="padding:8px;">0%</td>
                            <td id="break_diag_det" style="padding:8px;">‚Äî</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; font-weight:600;">Tratamiento</td>
                            <td id="break_trat" style="padding:8px;">0.00</td>
                            <td id="break_trat_pct" style="padding:8px;">0%</td>
                            <td id="break_trat_det" style="padding:8px;">‚Äî</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; font-weight:600;">Seguimiento</td>
                            <td id="break_seg" style="padding:8px;">0.00</td>
                            <td id="break_seg_pct" style="padding:8px;">0%</td>
                            <td id="break_seg_det" style="padding:8px;">‚Äî</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; font-weight:600;">Ingresos</td>
                            <td id="break_ing" style="padding:8px;">0.00</td>
                            <td id="break_ing_pct" style="padding:8px;">0%</td>
                            <td id="break_ing_det" style="padding:8px;">‚Äî</td>
                        </tr>
                        <tr style="border-top:1px solid #dee2e6;">
                            <td style="padding:8px; font-weight:800;">TOTAL</td>
                            <td id="break_total" style="padding:8px; font-weight:800;">0.00</td>
                            <td id="break_total_pct" style="padding:8px;">100%</td>
                            <td id="break_total_det" style="padding:8px;">‚Äî</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- =========================================
         JAVASCRIPT LOGIC
         ========================================= -->
    <script>
        // Variable que almacena la URL de tu Apps Script publicado
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwce0GYTD2oCWiuaiUVrZhsIvPjfjp9zz6ORiY0jXF5ypVC_F0WH8dnAIU5F4wi-qM/exec"; 
        const CONSTANTES = {
            consulta_ap: 2.3,
            prueba_aat: 2.532,
            espiro_boquilla: 0.1225,
            espiro_inhalador: 0.0352,
            espiro_maquina: 0.009,
            espiro_bronco: 0.036,
            ingreso_dia: 117
        };

        // Last computed numeric results (keep separate from DOM which might show units)
        let lastTotals = { diag: 0, trat: 0, seg: 0, ing: 0, total: 0 };

        // Opci√≥n de transportes global
        const TRANSPORTE_OPTIONS = `
            <option value="0.144">Autom√≥vil ligero</option>
            <option value="0.120">Motocicleta / ciclomotor</option>
            <option value="0.049">Autob√∫s urbano</option>
            <option value="0.033">Tren de cercan√≠as</option>
            <option value="0.030">Metro</option>
            <option value="0">Andando / A pie (0 emisiones)</option>
        `;

        // Device options for treatment (value = kg CO‚ÇÇe per device per year)
        const TRAT_DEVICE_OPTIONS = `
            <option value="17.59">pMDI (Cartucho presurizado)</option>
            <option value="0.684">DPI (Polvo seco)</option>
            <option value="0.78">SMI (Niebla fina)</option>
        `;

        const TRAT_DEVICE_FAMILIES = `
            <option value="SAMA">SAMA</option>
            <option value="SABA">SABA</option>
            <option value="LAMA">LAMA</option>
            <option value="LABA">LABA</option>
            <option value="LABA+LAMA">LABA + LAMA</option>
            <option value="LABA+ICS">LABA + ICS</option>
            <option value="LABA+LAMA+ICS">LABA + LAMA + ICS</option>
        `;

        // ===============================================
        // L√ìGICA DIN√ÅMICA: ACOMPA√ëANTES DIAGN√ìSTICO
        // ===============================================
        function renderAcompInputs(prefix) {
            const num = parseInt(document.getElementById(prefix + '_acomp_num').value) || 0;
            const container = document.getElementById(prefix + '_acomp_dynamic_rows');
            
            let existingValues = [];
            for(let i=0; i<container.children.length; i++) {
                let sel = document.getElementById(`${prefix}_ac_type_${i}`);
                let inp = document.getElementById(`${prefix}_ac_km_${i}`);
                if(sel && inp) existingValues.push({type: sel.value, km: inp.value});
            }

            container.innerHTML = ''; 

            for (let i = 0; i < num; i++) {
                const div = document.createElement('div');
                div.className = 'fila-dinamica';
                div.innerHTML = `
                    <div style="flex:1">
                        <label style="font-size:0.8em">Acompa√±ante ${i+1}</label>
                        <select id="${prefix}_ac_type_${i}" onchange="calcular()">
                            ${TRANSPORTE_OPTIONS}
                        </select>
                    </div>
                    <div style="flex:1">
                        <label style="font-size:0.8em">Km</label>
                        <input type="number" id="${prefix}_ac_km_${i}" value="0" min="0" oninput="calcular()">
                    </div>
                `;
                container.appendChild(div);

                if(i < existingValues.length) {
                    document.getElementById(`${prefix}_ac_type_${i}`).value = existingValues[i].type;
                    document.getElementById(`${prefix}_ac_km_${i}`).value = existingValues[i].km;
                }
            }
        }

        // Treatment devices: add/remove rows dynamically
        function addTratDevice(deviceType = '17.59', count = 12, family = 'SABA') {
            const container = document.getElementById('trat_devices_container');
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'fila-dinamica';
            div.id = `trat_device_row_${index}`;
            div.innerHTML = `
                <div style="flex:1">
                    <label>Dispositivo ${index+1}</label>
                    <select id="trat_device_type_${index}" onchange="calcular()">${TRAT_DEVICE_OPTIONS}</select>
                    <label style="font-size:0.85rem; margin-top:6px;">Familia</label>
                    <select id="trat_device_fam_${index}" onchange="calcular()">${TRAT_DEVICE_FAMILIES}</select>
                </div>
                <div style="flex:1">
                    <label>Envases al a√±o</label>
                    <input type="number" id="trat_device_cant_${index}" value="${count}" min="0" oninput="calcular()">
                </div>
                <div style="display:flex; align-items:flex-end; gap:10px;">
                    <button type="button" class="btn-small btn-danger" onclick="removeTratDevice(${index})">Eliminar</button>
                </div>
            `;
            container.appendChild(div);
            // Set default type & family
            document.getElementById(`trat_device_type_${index}`).value = deviceType;
            document.getElementById(`trat_device_fam_${index}`).value = family;
        }

        function removeTratDevice(index) {
            const container = document.getElementById('trat_devices_container');
            const row = document.getElementById(`trat_device_row_${index}`);
            if (row) row.remove();
            // Re-number remaining rows' IDs to keep sequence
                for (let i = 0; i < container.children.length; i++) {
                const child = container.children[i];
                child.id = `trat_device_row_${i}`;
                // update child selects/inputs IDs to reflect new index
                const sels = child.querySelectorAll('select');
                const inp = child.querySelector('input[type="number"]');
                if (sels.length > 0) {
                    // first select = dispositive type, second = family
                    sels[0].id = `trat_device_type_${i}`;
                    if (sels[1]) sels[1].id = `trat_device_fam_${i}`;
                }
                if (inp) inp.id = `trat_device_cant_${i}`;
                // update delete button onclick
                const btn = child.querySelector('button.btn-small');
                if (btn) btn.setAttribute('onclick', `removeTratDevice(${i})`);
                // update label
                const label = child.querySelector('label');
                if (label) label.innerText = `Dispositivo ${i+1}`;
            }
            calcular();
        }

        // Ingresos dynamic rows
        function addIngreso(dias = 5) {
            const container = document.getElementById('ing_dias_container');
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'fila-dinamica';
            div.id = `ing_row_${index}`;
            div.innerHTML = `
                <div style="flex:1">
                    <label>Ingreso ${index+1} - D√≠as est.:</label>
                    <input type="number" id="ing_dias_val_${index}" value="${dias}" min="1" oninput="calcular()">
                </div>
                <div style="display:flex; align-items:flex-end; gap:10px;">
                    <button type="button" class="btn-small btn-danger" onclick="removeIngreso(${index})">Eliminar</button>
                </div>
            `;
            container.appendChild(div);
        }

        function removeIngreso(index) {
            const container = document.getElementById('ing_dias_container');
            const row = document.getElementById(`ing_row_${index}`);
            if (row) row.remove();
            // Reindex the remaining rows
            for (let i=0; i<container.children.length; i++) {
                const child = container.children[i];
                child.id = `ing_row_${i}`;
                const inp = child.querySelector('input[type="number"]');
                if (inp) inp.id = `ing_dias_val_${i}`;
                const btn = child.querySelector('button.btn-small');
                if (btn) btn.setAttribute('onclick', `removeIngreso(${i})`);
                const label = child.querySelector('label');
                if (label) label.innerText = `Ingreso ${i+1} - D√≠as est:`;
            }
            calcular();
        }

        // ===============================================
        // L√ìGICA DIN√ÅMICA: CONSULTAS SEGUIMIENTO
        // ===============================================
        function renderSeguimientoInputs() {
            const num = parseInt(document.getElementById('seg_num_cons').value) || 0;
            const container = document.getElementById('seg_consultas_container');

            // Guardamos el estado actual para no perder datos al cambiar el n√∫mero
            let state = [];
            for(let i=0; i<container.children.length; i++) {
                let t_type = document.getElementById(`seg_t_type_${i}`)?.value;
                let t_km = document.getElementById(`seg_t_km_${i}`)?.value;
                let t_setting = document.getElementById(`seg_setting_${i}`)?.value || 'primaria';
                
                // Radio buttons son m√°s truculentos de guardar
                let has_acomp = 'no';
                if(document.querySelector(`input[name="seg_acomp_check_${i}"]:checked`)) {
                    has_acomp = document.querySelector(`input[name="seg_acomp_check_${i}"]:checked`).value;
                }
                
                let num_acomp = document.getElementById(`seg_acomp_num_${i}`)?.value || 1;
                
                // Acompa√±antes rows
                let rows_data = [];
                let row_cont = document.getElementById(`seg_acomp_rows_${i}`);
                if(row_cont) {
                    for(let j=0; j<row_cont.children.length; j++) {
                        let at = document.getElementById(`seg_acomp_t_${i}_${j}`)?.value;
                        let ak = document.getElementById(`seg_acomp_k_${i}_${j}`)?.value;
                        rows_data.push({t: at, k: ak});
                    }
                }
                
                state.push({
                    t_type, t_km, t_setting, has_acomp, num_acomp, rows_data
                });
            }

            container.innerHTML = '';

            for(let i=0; i<num; i++) {
                const div = document.createElement('div');
                div.className = 'bloque-consulta';
                div.innerHTML = `
                    <h5 style="margin-top:0; color:var(--azul-medio); border-bottom:1px solid #eee; padding-bottom:5px;">Consulta de Seguimiento #${i+1}</h5>
                    <div class="row">
                        <div class="col">
                            <label style="font-size:0.9em">Transporte Paciente</label>
                            <select id="seg_t_type_${i}" onchange="calcular()">
                                ${TRANSPORTE_OPTIONS}
                            </select>
                            <label style="font-size:0.9em; margin-top:6px;">√Åmbito</label>
                            <select id="seg_setting_${i}" onchange="calcular()">
                                <option value="primaria">Atenci√≥n Primaria</option>
                                <option value="hospital">Atenci√≥n Hospitalaria</option>
                            </select>
                        </div>
                        <div class="col">
                            <label style="font-size:0.9em">Km</label>
                            <input type="number" id="seg_t_km_${i}" value="0" min="0" oninput="calcular()">
                        </div>
                    </div>

                    <div class="input-group" style="margin-top:10px; border-top:1px dashed #eee; padding-top:10px;">
                        <label style="font-size:0.9em">¬øAcude con acompa√±antes?</label>
                        <div class="radio-group">
                            <label class="radio-option"><input type="radio" name="seg_acomp_check_${i}" value="no" checked onchange="toggleAcompSeg(${i}); calcular()"> No</label>
                            <label class="radio-option"><input type="radio" name="seg_acomp_check_${i}" value="si" onchange="toggleAcompSeg(${i}); calcular()"> S√≠</label>
                        </div>
                    </div>

                    <div id="seg_acomp_panel_${i}" class="hidden" style="margin-left:10px; padding-left:10px; border-left:3px solid var(--azul-claro);">
                        <label style="font-size:0.9em">N¬∫ Acompa√±antes:</label>
                        <input type="number" id="seg_acomp_num_${i}" value="1" min="1" max="5" style="width:80px;" onchange="renderAcompInputsSeg(${i}); calcular()">
                        <div id="seg_acomp_rows_${i}" style="margin-top:10px;"></div>
                    </div>
                `;
                container.appendChild(div);

                // Restaurar estado si existe
                if(i < state.length) {
                    if(state[i].t_type) document.getElementById(`seg_t_type_${i}`).value = state[i].t_type;
                    if(state[i].t_km) document.getElementById(`seg_t_km_${i}`).value = state[i].t_km;
                    if(state[i].t_setting) document.getElementById(`seg_setting_${i}`).value = state[i].t_setting;
                    
                    // Restaurar radio
                    let radios = document.getElementsByName(`seg_acomp_check_${i}`);
                    for(let r of radios) {
                        if(r.value === state[i].has_acomp) r.checked = true;
                    }
                    
                    // Restaurar panel acompa√±antes
                    if(state[i].has_acomp === 'si') {
                        document.getElementById(`seg_acomp_panel_${i}`).classList.remove('hidden');
                        document.getElementById(`seg_acomp_num_${i}`).value = state[i].num_acomp;
                        renderAcompInputsSeg(i, state[i].rows_data); 
                    }
                }
            }
        }

        function toggleAcompSeg(index) {
            let val = document.querySelector(`input[name="seg_acomp_check_${index}"]:checked`).value;
            let panel = document.getElementById(`seg_acomp_panel_${index}`);
            if(val === 'si') {
                panel.classList.remove('hidden');
                if(document.getElementById(`seg_acomp_rows_${index}`).innerHTML === '') {
                    renderAcompInputsSeg(index);
                }
            } else {
                panel.classList.add('hidden');
            }
        }

        function renderAcompInputsSeg(index, savedData = null) {
            let num = parseInt(document.getElementById(`seg_acomp_num_${index}`).value) || 0;
            let container = document.getElementById(`seg_acomp_rows_${index}`);
            
            // Si no pasamos savedData, intentamos capturar lo que hay ahora en pantalla para no borrarlo
            if(!savedData) {
                savedData = [];
                for(let j=0; j<container.children.length; j++) {
                     let at = document.getElementById(`seg_acomp_t_${index}_${j}`)?.value;
                     let ak = document.getElementById(`seg_acomp_k_${index}_${j}`)?.value;
                     if(at && ak) savedData.push({t: at, k: ak});
                }
            }

            container.innerHTML = '';

            for(let j=0; j<num; j++) {
                const row = document.createElement('div');
                row.className = 'fila-dinamica';
                row.innerHTML = `
                    <div style="flex:1">
                         <label style="font-size:0.75em">Acomp. ${j+1} - Medio</label>
                         <select id="seg_acomp_t_${index}_${j}" onchange="calcular()" style="padding:5px; font-size:0.9em;">
                            ${TRANSPORTE_OPTIONS}
                         </select>
                    </div>
                    <div style="flex:1">
                         <label style="font-size:0.75em">Km</label>
                         <input type="number" id="seg_acomp_k_${index}_${j}" value="0" min="0" oninput="calcular()" style="padding:5px; font-size:0.9em;">
                    </div>
                `;
                container.appendChild(row);

                if(savedData && j < savedData.length) {
                    document.getElementById(`seg_acomp_t_${index}_${j}`).value = savedData[j].t;
                    document.getElementById(`seg_acomp_k_${index}_${j}`).value = savedData[j].k;
                }
            }
        }


        // --- FUNCIONES UI GENERALES ---
        function openTab(tabId, btnElement) {
            // If Diagn√≥stico is disabled (older than 1 year), show message with patient name & don't open
            if (tabId === 'diag' && typeof diagEnabled !== 'undefined' && !diagEnabled) {
                const first = document.getElementById('info_first_name')?.value || '';
                const last = document.getElementById('info_last_name')?.value || '';
                const nameFull = (first + ' ' + last).trim() || 'este paciente';
                const diagDate = document.getElementById('info_diag_date')?.value || '‚Äî';
                alert(`La fase Diagn√≥stico no se ha incluido en el c√°lculo anual de emisiones generadas del proceso asistencial del paciente ${nameFull} porque su fecha de diagn√≥stico (${diagDate}) es superior a un a√±o.`);
                return;
            }
            document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            const content = document.getElementById(tabId);
            if (!content) return;
            content.classList.add('active');
            let btn = btnElement;
            if (!btn) btn = document.getElementById('tab_button_' + tabId);
            if (btn) btn.classList.add('active');
            if(tabId === 'res') { calcular(); updateResultsSummary(); }
        }

        function toggleAcomp(prefix) {
            // Check radio value for Diagnostico
            let val = document.querySelector(`input[name="${prefix}_acomp_check"]:checked`).value;
            const panel = document.getElementById(prefix + '_acomp_panel');
            if(val === 'si') {
                panel.classList.remove('hidden');
                if(document.getElementById(prefix + '_acomp_dynamic_rows').innerHTML === '') {
                    renderAcompInputs(prefix);
                }
            } else {
                panel.classList.add('hidden');
            }
        }

        function toggleDiagEspirometria() {
            const done = document.querySelector('input[name="diag_espiro_done"]:checked')?.value === 'si';
            const block = document.getElementById('diag_espiro_repeat_block');
            const res = document.getElementById('res_espiro_diag');
            if(!block) return;
            if (done) { block.classList.remove('hidden'); if(res) res.style.display = ''; }
            else { block.classList.add('hidden'); if(res) res.style.display = 'none'; }
        }

        function toggleVisitaExtra() {
            // Check radio for same visit
            let val = document.querySelector('input[name="seg_misma_visita"]:checked').value;
            const block = document.getElementById('seg_extra_block');
            if(val === 'no') block.classList.remove('hidden');
            else block.classList.add('hidden');
        }

        function toggleSegEspirometria() {
            const done = document.querySelector('input[name="seg_espiro_done"]:checked')?.value === 'si';
            const controlsBlock = document.getElementById('seg_espiro_controls_block');
            if (controlsBlock) {
                if (done) controlsBlock.classList.remove('hidden');
                else controlsBlock.classList.add('hidden');
            }
            // If not done, hide extra block as well
            if (!done) {
                document.getElementById('seg_extra_block')?.classList.add('hidden');
            } else {
                // Evaluate if seg_extra_block should show according to seg_misma_visita
                toggleVisitaExtra();
            }
        }

        function toggleIngreso() {
            const radios = document.getElementsByName('ing_check');
            let val = 'no';
            for(let r of radios) if(r.checked) val = r.value;
            const block = document.getElementById('ing_dias_block');
            const container = document.getElementById('ing_dias_container');
            if(val === 'si') {
                block.classList.remove('hidden');
                // ensure at least one ingreso row exists when enabled
                if (container && container.children.length === 0) addIngreso(5);
            } else {
                block.classList.add('hidden');
            }
        }

        // diag toggle global + Info. General handlers
        let diagEnabled = true;

        function toggleDiagTab(show) {
            const btn = document.getElementById('tab_button_diag');
            const content = document.getElementById('diag');
            diagEnabled = !!show;
            if (show) {
                if (btn) { btn.classList.remove('hidden'); btn.style.display = ''; btn.classList.remove('disabled'); }
            } else {
                if (btn) { btn.classList.remove('hidden'); btn.style.display = ''; btn.classList.add('disabled'); }
                if (content && content.classList.contains('active')) {
                    const fallbackButton = document.getElementById('tab_button_info') || document.getElementById('tab_button_trat');
                    if (fallbackButton) openTab('info', fallbackButton);
                }
            }
        }

        function updateInfo() {
            const firstName = document.getElementById('info_first_name')?.value || '';
            const lastName = document.getElementById('info_last_name')?.value || '';
            const center = document.getElementById('info_center')?.value || '';
            const dob = document.getElementById('info_dob')?.value || '';
            const diagDate = document.getElementById('info_diag_date')?.value || '';

            // Compute age from DOB
            let ageText = 'Edad: ‚Äî';
            if (dob) {
                const d = new Date(dob);
                const now = new Date();
                let ageYears = now.getFullYear() - d.getFullYear();
                const m = now.getMonth() - d.getMonth();
                if (m < 0 || (m === 0 && now.getDate() < d.getDate())) ageYears--;
                if (ageYears < 0) ageYears = 0;
                ageText = 'Edad: ' + ageYears + ' a√±o' + (ageYears !== 1 ? 's' : '');
            }
            if (document.getElementById('info_dob_age')) document.getElementById('info_dob_age').innerText = ageText;

            // Calculate diagnosis duration
            let durationText = '‚Äî';
            // By default, show the Diagn√≥stico tab unless a diagDate indicates otherwise
            let showDiag = true;
            if (diagDate) {
                const d = new Date(diagDate);
                const now = new Date();
                let years = now.getFullYear() - d.getFullYear();
                let months = now.getMonth() - d.getMonth();
                if (months < 0) { years -= 1; months += 12; }
                if (years < 0) years = 0;
                durationText = `${years} a√±o${years !== 1 ? 's' : ''}` + (months ? `, ${months} mes${months !== 1 ? 'es' : ''}` : '');
                const diffDays = Math.floor((now - d) / (1000 * 60 * 60 * 24));
                showDiag = (diffDays <= 365);
            }
            if (document.getElementById('info_diag_duration')) document.getElementById('info_diag_duration').innerText = durationText;

            // Toggle diag tab
            toggleDiagTab(showDiag);

            // Toggle notice
            const notice = document.getElementById('info_diag_notice');
            if (notice) { if (showDiag) notice.classList.add('hidden'); else notice.classList.remove('hidden'); }

            // Update summary
            const nameFull = (firstName + ' ' + lastName).trim();
            if (document.getElementById('info_summary_name')) document.getElementById('info_summary_name').innerText = 'Nombre: ' + (nameFull || '‚Äî');
            if (document.getElementById('info_summary_center')) document.getElementById('info_summary_center').innerText = 'Centro: ' + (center || '‚Äî');
            if (document.getElementById('info_summary_dob')) document.getElementById('info_summary_dob').innerText = 'Fecha Nac.: ' + (dob || '‚Äî');
            if (document.getElementById('info_summary_diag')) document.getElementById('info_summary_diag').innerText = 'Fecha Diagn√≥stico: ' + (diagDate || '‚Äî');
            if (document.getElementById('info_summary_duration')) document.getElementById('info_summary_duration').innerText = 'Tiempo desde diagn√≥stico: ' + durationText;

            // If results are visible, also update the results page summary
            if (typeof updateResultsSummary === 'function') updateResultsSummary();
        }

        // --- C√ÅLCULO PRINCIPAL ---
        function calcular() {
            // 1. DIAGN√ìSTICO
            let total_diag = 0;
            if (typeof diagEnabled === 'undefined' || diagEnabled) {
                // Hemograma optional
                let hemograma_selected = document.querySelector('input[name="diag_hemograma"]:checked')?.value === 'si';
                let diag_clinico = CONSTANTES.consulta_ap + (hemograma_selected ? CONSTANTES.prueba_aat : 0);

                // Espirometr√≠a only if performed
                let espiro_performed = document.querySelector('input[name="diag_espiro_done"]:checked')?.value === 'si';
                let espiro_val = 0;
                if (espiro_performed) {
                    let d_rep = document.querySelector('input[name="diag_rep"]:checked')?.value === 'si';
                    let mult = d_rep ? 2 : 1;
                    espiro_val = CONSTANTES.consulta_ap + ((CONSTANTES.espiro_boquilla + CONSTANTES.espiro_inhalador + CONSTANTES.espiro_maquina) * mult);
                }
                document.getElementById('res_espiro_diag').innerText = "Impacto: " + espiro_val.toFixed(3) + " kg";

                // Transporte Paciente
                let d_t_factor = parseFloat(document.getElementById('diag_transp_tipo')?.value) || 0;
                let d_t_km = parseFloat(document.getElementById('diag_transp_km')?.value) || 0;
                let d_transp_total = d_t_factor * d_t_km;

                // Mostrar impacto Hemograma (si/no)
                const rHem = document.getElementById('res_hemograma');
                if (rHem) {
                    if (hemograma_selected) { rHem.classList.remove('hidden'); rHem.innerText = 'Impacto Hemograma: ' + CONSTANTES.prueba_aat.toFixed(3) + ' kg'; }
                    else { rHem.classList.add('hidden'); rHem.innerText = 'Impacto Hemograma: 0.000 kg'; }
                }

                // Transporte Acompa√±antes Din√°micos
                let d_acomp_si = document.querySelector('input[name="diag_acomp_check"]:checked')?.value === 'si';
                if(d_acomp_si) {
                    const num = parseInt(document.getElementById('diag_acomp_num')?.value) || 0;
                    for(let i=0; i<num; i++) {
                        let t = parseFloat(document.getElementById(`diag_ac_type_${i}`)?.value) || 0;
                        let k = parseFloat(document.getElementById(`diag_ac_km_${i}`)?.value) || 0;
                        d_transp_total += (t * k);
                    }
                }
                document.getElementById('diag_transp_res').innerText = "Impacto Transporte Total: " + d_transp_total.toFixed(3) + " kg";

                total_diag = diag_clinico + espiro_val + d_transp_total;
                document.getElementById('total_diag_display').innerText = total_diag.toFixed(3);
            } else {
                document.getElementById('res_espiro_diag').innerText = "Impacto: 0.000 kg";
                document.getElementById('diag_transp_res').innerText = "Impacto Transporte Total: 0.000 kg";
                document.getElementById('total_diag_display').innerText = (0).toFixed(3);
            }


            // 2. TRATAMIENTO
            // Tratamiento: sum all devices
            let total_trat = 0;
            const container = document.getElementById('trat_devices_container');
            if (container && container.children.length > 0) {
                for (let i=0; i<container.children.length; i++) {
                    let f = parseFloat(document.getElementById(`trat_device_type_${i}`)?.value) || 0;
                    let c = parseFloat(document.getElementById(`trat_device_cant_${i}`)?.value) || 0;
                    total_trat += f * c;
                }
            }
            document.getElementById('total_trat_display').innerText = total_trat.toFixed(3);


            // 3. SEGUIMIENTO
            // Cl√≠nico
            let s_num = parseInt(document.getElementById('seg_num_cons').value) || 0;
            let s_clinico = s_num * CONSTANTES.consulta_ap;

            // Espirometr√≠a
            let espiro_done = document.querySelector('input[name="seg_espiro_done"]:checked')?.value === 'si';
            let s_rep = document.querySelector('input[name="seg_espiro_rep"]:checked')?.value === 'si';
            let mult_s = s_rep ? 2 : 1;
            let s_espiro_val = 0;
            if (espiro_done) {
                s_espiro_val = (CONSTANTES.espiro_boquilla * mult_s) + CONSTANTES.espiro_bronco + (CONSTANTES.espiro_maquina * mult_s);
            }

            // Transporte (Suma de cada ficha de consulta)
            let s_transp_total = 0;
            
            for(let i=0; i<s_num; i++) {
                // Paciente
                let pt = parseFloat(document.getElementById(`seg_t_type_${i}`)?.value) || 0;
                let pk = parseFloat(document.getElementById(`seg_t_km_${i}`)?.value) || 0;
                s_transp_total += (pt * pk);

                // Acompa√±antes de esta consulta
                let has_acomp = 'no';
                if(document.querySelector(`input[name="seg_acomp_check_${i}"]:checked`)) {
                    has_acomp = document.querySelector(`input[name="seg_acomp_check_${i}"]:checked`).value;
                }

                if(has_acomp === 'si') {
                    let num_ac = parseInt(document.getElementById(`seg_acomp_num_${i}`)?.value) || 0;
                    for(let j=0; j<num_ac; j++) {
                        let at = parseFloat(document.getElementById(`seg_acomp_t_${i}_${j}`)?.value) || 0;
                        let ak = parseFloat(document.getElementById(`seg_acomp_k_${i}_${j}`)?.value) || 0;
                        s_transp_total += (at * ak);
                    }
                }
            }

            // Visita Extra Espiro
            let misma_visita = document.querySelector('input[name="seg_misma_visita"]:checked').value === 'si';
            let s_extra_val = 0;
            let s_extra_transp = 0;

            if(!misma_visita) {
                s_extra_val = CONSTANTES.consulta_ap;
                // Transporte extra espec√≠fico
                let et = parseFloat(document.getElementById('seg_extra_tipo').value) || 0;
                let ek = parseFloat(document.getElementById('seg_extra_km').value) || 0;
                s_extra_transp = et * ek; 
            }

            let total_seg = s_clinico + s_espiro_val + s_transp_total + s_extra_val + s_extra_transp;
            document.getElementById('total_seg_display').innerText = total_seg.toFixed(3);


            // 4. INGRESOS
            let total_ing = 0;
            if(document.querySelector('input[name="ing_check"]:checked')?.value === 'si') {
                // sum all ingreso rows
                const ingContainer = document.getElementById('ing_dias_container');
                if (ingContainer && ingContainer.children.length > 0) {
                    let daysSum = 0;
                    for (let i=0; i<ingContainer.children.length; i++) {
                        let val = parseFloat(document.getElementById(`ing_dias_val_${i}`)?.value) || 0;
                        daysSum += val;
                    }
                    total_ing = daysSum * CONSTANTES.ingreso_dia;
                }
            }
            document.getElementById('total_ing_display').innerText = total_ing.toFixed(3);


            // 5. RESULTADOS
            let gran_total = total_diag + total_trat + total_seg + total_ing;
            // Save numerics
            lastTotals = { diag: total_diag, trat: total_trat, seg: total_seg, ing: total_ing, total: gran_total };

            // Update UI values including units to make units explicit
            document.getElementById('gran_total').innerText = gran_total.toFixed(2) + ' kg CO‚ÇÇe';

            document.getElementById('res_diag').innerText = total_diag.toFixed(1) + ' kg CO‚ÇÇe';
            document.getElementById('res_trat').innerText = total_trat.toFixed(1) + ' kg CO‚ÇÇe';
            document.getElementById('res_seg').innerText = total_seg.toFixed(1) + ' kg CO‚ÇÇe';
            document.getElementById('res_ing').innerText = total_ing.toFixed(1) + ' kg CO‚ÇÇe';

            updateChart(total_diag, total_trat, total_seg, total_ing);
            // Update the more detailed results summary and table
            updateResultsSummary();
        }

        function updateChart(v1, v2, v3, v4) {
            let max = Math.max(v1, v2, v3, v4);
            if(max === 0) max = 1; 
            
            setBar('bar_diag', 'g_val_diag', v1, max);
            setBar('bar_trat', 'g_val_trat', v2, max);
            setBar('bar_seg', 'g_val_seg', v3, max);
            setBar('bar_ing', 'g_val_ing', v4, max);
        }

        function setBar(barId, labelId, value, max) {
            let percentage = (value / max) * 100 * 0.9;
            if(value > 0 && percentage < 1) percentage = 1;
            document.getElementById(barId).style.height = percentage + "%";
            document.getElementById(labelId).innerText = value.toFixed(1) + ' kg CO‚ÇÇe';
        }

        // Sanitize a filename (remove problematic characters and spaces)
        function sanitizeFilename(name) {
            return name.replace(/[^a-z0-9_\-]+/gi, '_').replace(/__+/g, '_').trim();
        }

        // Update the summary area in the Results tab and the breakdown table
        function updateResultsSummary() {
            // Patient info
            const pFirstName = document.getElementById('info_first_name')?.value || '';
            const pLastName = document.getElementById('info_last_name')?.value || '';
            const pCenter = document.getElementById('info_center')?.value || '‚Äî';
            const pDob = document.getElementById('info_dob')?.value || '‚Äî';
            const pDiag = document.getElementById('info_diag_date')?.value || '‚Äî';
            const pAgeText = document.getElementById('info_dob_age')?.innerText || 'Edad: ‚Äî';
            const pDiagDur = document.getElementById('info_summary_duration')?.innerText || '‚Äî';

            if (document.getElementById('res_pat_name')) document.getElementById('res_pat_name').innerText = (pFirstName + ' ' + pLastName).trim() || '‚Äî';
            if (document.getElementById('res_pat_dob')) document.getElementById('res_pat_dob').innerText = pDob;
            if (document.getElementById('res_pat_center')) document.getElementById('res_pat_center').innerText = pCenter;
            if (document.getElementById('res_pat_diag')) document.getElementById('res_pat_diag').innerText = pDiag;
            if (document.getElementById('res_pat_age')) document.getElementById('res_pat_age').innerText = pAgeText;
            if (document.getElementById('res_pat_diag_duration')) document.getElementById('res_pat_diag_duration').innerText = pDiagDur;

            // Timestamp
            const now = new Date();
            const timeStr = now.toLocaleString();
            if (document.getElementById('res_report_time')) document.getElementById('res_report_time').innerText = timeStr;

            // Use numeric totals saved by calcular
            const vDiag = (lastTotals && lastTotals.diag) ? lastTotals.diag : (parseFloat(document.getElementById('res_diag')?.innerText) || 0);
            const vTrat = (lastTotals && lastTotals.trat) ? lastTotals.trat : (parseFloat(document.getElementById('res_trat')?.innerText) || 0);
            const vSeg = (lastTotals && lastTotals.seg) ? lastTotals.seg : (parseFloat(document.getElementById('res_seg')?.innerText) || 0);
            const vIng = (lastTotals && lastTotals.ing) ? lastTotals.ing : (parseFloat(document.getElementById('res_ing')?.innerText) || 0);
            const total = (lastTotals && lastTotals.total) ? lastTotals.total : (vDiag + vTrat + vSeg + vIng);

            // Avoid divide by zero
            const totalForPct = (total === 0 ? 1 : total);

            // Update table values and details
            if (document.getElementById('break_diag')) document.getElementById('break_diag').innerText = vDiag.toFixed(3);
            if (document.getElementById('break_diag_pct')) document.getElementById('break_diag_pct').innerText = ((vDiag / totalForPct) * 100).toFixed(1) + '%';
            // diag details: hemograma yes/no, espiro yes/no, transporte km
            let diagDet = [];
            if (document.querySelector('input[name="diag_hemograma"]:checked')) diagDet.push('Hemograma: ' + (document.querySelector('input[name="diag_hemograma"]:checked').value === 'si' ? 'S√≠' : 'No'));
            if (document.querySelector('input[name="diag_espiro_done"]:checked')) diagDet.push('Espirometr√≠a: ' + (document.querySelector('input[name="diag_espiro_done"]:checked').value === 'si' ? 'S√≠' : 'No'));
            const dKm = parseFloat(document.getElementById('diag_transp_km')?.value) || 0;
            if (dKm) diagDet.push('Km paciente: ' + dKm + ' km');
            if (document.getElementById('break_diag_det')) document.getElementById('break_diag_det').innerText = diagDet.join(' ¬∑ ') || '‚Äî';

            if (document.getElementById('break_trat')) document.getElementById('break_trat').innerText = vTrat.toFixed(3);
            if (document.getElementById('break_trat_pct')) document.getElementById('break_trat_pct').innerText = ((vTrat / totalForPct) * 100).toFixed(1) + '%';
            // treatment details: count devices, families
            const tContainer = document.getElementById('trat_devices_container');
            let tCount = 0; let families = {};
            if (tContainer) {
                tCount = tContainer.children.length;
                for (let i=0;i<tCount;i++) {
                    const fam = document.getElementById(`trat_device_fam_${i}`)?.value || '‚Äî';
                    families[fam] = (families[fam] || 0) + 1;
                }
            }
            let tDetail = `${tCount} dispositivo(s)` + (tCount ? ' ¬∑ ' + Object.keys(families).map(k => `${k}(${families[k]})`).join(', ') : '');
            if (document.getElementById('break_trat_det')) document.getElementById('break_trat_det').innerText = tDetail || '‚Äî';

            if (document.getElementById('break_seg')) document.getElementById('break_seg').innerText = vSeg.toFixed(3);
            if (document.getElementById('break_seg_pct')) document.getElementById('break_seg_pct').innerText = ((vSeg / totalForPct) * 100).toFixed(1) + '%';
            // seguimiento detail: number of consultations, espirometry performed?
            const segCons = parseInt(document.getElementById('seg_num_cons')?.value) || 0;
            const segEsp = (document.querySelector('input[name="seg_espiro_done"]:checked')?.value === 'si') ? 'S√≠' : 'No';
            let segDetail = `${segCons} consulta(s)` + ` ¬∑ Espirometr√≠a: ${segEsp}`;
            if (document.getElementById('break_seg_det')) document.getElementById('break_seg_det').innerText = segDetail || '‚Äî';

            if (document.getElementById('break_ing')) document.getElementById('break_ing').innerText = vIng.toFixed(3);
            if (document.getElementById('break_ing_pct')) document.getElementById('break_ing_pct').innerText = ((vIng / totalForPct) * 100).toFixed(1) + '%';
            // ingresos detail: count and total days
            const ingContainer = document.getElementById('ing_dias_container');
            let ingCount = 0; let ingTotalDays = 0;
            if (ingContainer) {
                ingCount = ingContainer.children.length;
                for (let i=0;i<ingCount;i++) {
                    ingTotalDays += parseFloat(document.getElementById(`ing_dias_val_${i}`)?.value) || 0;
                }
            }
            if (document.getElementById('break_ing_det')) document.getElementById('break_ing_det').innerText = `${ingCount} ingreso(s) ¬∑ ${ingTotalDays} d√≠a(s)` || '‚Äî';

            if (document.getElementById('break_total')) document.getElementById('break_total').innerText = total.toFixed(3);
            if (document.getElementById('break_total_pct')) document.getElementById('break_total_pct').innerText = '100%';
            if (document.getElementById('break_total_det')) {
                document.getElementById('break_total_det').innerText = `Dispositivos: ${tCount} ¬∑ Consultas: ${segCons} ¬∑ Ingresos: ${ingCount}`;
            }

            // Update CSV filename display
            const cleanName = (pFirstName || 'Nombre') + '_' + (pLastName || 'Paciente');
            const fname = sanitizeFilename(cleanName) + '_HC.csv';
            if (document.getElementById('res_csv_filename')) document.getElementById('res_csv_filename').innerText = fname;
        }

        function sendDataToSheet() {
            // 1. INFO GENERAL Y METADATOS
            const pFirstName = document.getElementById('info_first_name')?.value || '';
            const pLastName = document.getElementById('info_last_name')?.value || '';
            const pCenter = document.getElementById('info_center')?.value || '';
            const pDiagDate = document.getElementById('info_diag_date')?.value || '';
            const pDob = document.getElementById('info_dob')?.value || '';
            
            const now = new Date();
            const uniqueId = sanitizeFilename((pLastName || 'P') + (pFirstName.charAt(0) || '0')) + '_' + now.getTime();

            // HC Totals are taken from the last computation
            const d = lastTotals.diag.toFixed(3);
            const t = lastTotals.trat.toFixed(3);
            const s = lastTotals.seg.toFixed(3);
            const i = lastTotals.ing.toFixed(3);
            const total = lastTotals.total.toFixed(3);

            // --- Definici√≥n de valor de relleno ---
            const FILL_VALUE = '-'; 

            // --- DEFINICI√ìN DE CABECERA (NO SE USA PARA ENVIAR DATOS, SOLO PARA REFERENCIA)
            let headerRow = [
                'ID_PACIENTE', 'NOMBRE', 'APELLIDOS', 'FECHA_NAC', 'CENTRO', 'FECHA_DIAG', 
                'HC_TOTAL_KGCO2E', 'HC_DIAG', 'HC_TRAT', 'HC_SEG', 'HC_ING', 'FECHA_INFORME', "HORA_INFORME"
            ];
            // --- DEFINICI√ìN DE FILA DE DATOS ---
            let dataRow = [
                uniqueId, pFirstName, pLastName, pDob, pCenter, pDiagDate,
                total, d, t, s, i, now.toLocaleString()
            ];

            // 2. DETALLE DIAGN√ìSTICO Y TRANSPORTE
            const diagEnabled = (typeof window.diagEnabled === 'undefined' || window.diagEnabled); 
            const hemograma_selected = document.querySelector('input[name="diag_hemograma"]:checked')?.value === 'si';
            const espiro_performed = document.querySelector('input[name="diag_espiro_done"]:checked')?.value === 'si';
            const espiro_rep = document.querySelector('input[name="diag_rep"]:checked')?.value === 'si';

            headerRow.push('D_HEMOGRAMA_SI_NO', 'D_ESPIRO_SI_NO', 'D_ESPIRO_REP_SI_NO');
            if (diagEnabled) {
                dataRow.push(
                    hemograma_selected ? 'Si' : 'No',
                    espiro_performed ? 'Si' : 'No',
                    (espiro_performed && espiro_rep) ? 'Si' : 'No'
                );
            } else {
                dataRow.push(FILL_VALUE, FILL_VALUE, FILL_VALUE);
            }

            // Transporte Paciente (Diagn√≥stico)
            const d_p_type = document.getElementById('diag_transp_tipo')?.options[document.getElementById('diag_transp_tipo').selectedIndex].text || FILL_VALUE;
            const d_p_km = document.getElementById('diag_transp_km')?.value || 0;
            
            headerRow.push('D_P_TIPO', 'D_P_KM');
            dataRow.push(d_p_type, d_p_km);

            // Transporte Acompa√±antes (Diagn√≥stico - MAX 3)
            const d_acomp_si = document.querySelector('input[name="diag_acomp_check"]:checked')?.value === 'si';
            const d_num_acomp = d_acomp_si ? parseInt(document.getElementById('diag_acomp_num')?.value) || 0 : 0;
            
            for(let j=1; j<=3; j++) {
                headerRow.push(`D_A${j}_TIPO`, `D_A${j}_KM`);
                if (j <= d_num_acomp) {
                    const selectElement = document.getElementById(`diag_ac_type_${j-1}`);
                    const inputElement = document.getElementById(`diag_ac_km_${j-1}`);
                    
                    const tipo = selectElement ? selectElement.options[selectElement.selectedIndex].text : FILL_VALUE;
                    const km = inputElement ? inputElement.value : 0;
                    
                    dataRow.push(tipo, km);
                } else {
                    dataRow.push(FILL_VALUE, FILL_VALUE); // Pad with guiones
                }
            }


            // 3. TRATAMIENTO (MAX 3 DISPOSITIVOS)
            const trat_devices = document.getElementById('trat_devices_container');
            const deviceCount = (trat_devices ? trat_devices.children.length : 0);

            for(let j=1; j<=3; j++) {
                headerRow.push(`T_D${j}_TIPO`, `T_D${j}_FAMILIA`, `T_D${j}_ENVASES`);

                if (j <= deviceCount) {
                    const dsel = document.getElementById(`trat_device_type_${j-1}`);
                    const fsel = document.getElementById(`trat_device_fam_${j-1}`);
                    const cval = document.getElementById(`trat_device_cant_${j-1}`)?.value || '0';

                    const tipo = dsel ? dsel.options[dsel.selectedIndex].text : FILL_VALUE;
                    const familia = fsel ? fsel.value : FILL_VALUE;
                    
                    dataRow.push(tipo, familia, cval);
                } else {
                    dataRow.push(FILL_VALUE, FILL_VALUE, FILL_VALUE); // Pad with guiones
                }
            }


            // 4. INGRESOS (ACUMULADOS)
            const ingContainer = document.getElementById('ing_dias_container');
            let ingCount = 0; 
            let ingTotalDays = 0;

            if(document.querySelector('input[name="ing_check"]:checked')?.value === 'si') {
                ingCount = (ingContainer ? ingContainer.children.length : 0);
                if (ingContainer) {
                    for (let i = 0; i < ingCount; i++) {
                        ingTotalDays += parseFloat(document.getElementById(`ing_dias_val_${i}`)?.value) || 0;
                    }
                }
            }

            headerRow.push('I_NUM_INGRESOS', 'I_DIAS_ACUMULADOS');
            dataRow.push(ingCount, ingTotalDays);


            // 5. SEGUIMIENTO (MAX 6 CONSULTAS)
            const s_num = parseInt(document.getElementById('seg_num_cons')?.value) || 0;
            const max_consultas = 6;
            const max_acomp_seg = 3; 

            for(let i=0; i<max_consultas; i++) {
                // Headers for Consulta C1 to C6 (Patient + up to 3 companions)
                headerRow.push(`C${i+1}_SETTING`, `C${i+1}_P_TIPO`, `C${i+1}_P_KM`);
                for (let j=1; j<=max_acomp_seg; j++) {
                    headerRow.push(`C${i+1}_A${j}_TIPO`, `C${i+1}_A${j}_KM`);
                }
                
                if (i < s_num) {
                    // Data for this consultation
                    const setting = document.getElementById(`seg_setting_${i}`)?.value || FILL_VALUE;
                    const p_type_el = document.getElementById(`seg_t_type_${i}`);
                    const p_type = p_type_el ? p_type_el.options[p_type_el.selectedIndex].text : FILL_VALUE;
                    const p_km = document.getElementById(`seg_t_km_${i}`)?.value || 0;

                    dataRow.push(setting, p_type, p_km);

                    // Acompa√±antes de esta consulta (MAX 3)
                    let has_acomp = document.querySelector(`input[name="seg_acomp_check_${i}"]:checked`)?.value === 'si';
                    let num_ac = has_acomp ? parseInt(document.getElementById(`seg_acomp_num_${i}`)?.value) || 0 : 0;
                    
                    for(let j=1; j<=max_acomp_seg; j++) {
                        if(j <= num_ac) {
                            const at_el = document.getElementById(`seg_acomp_t_${i}_${j-1}`);
                            const ak = document.getElementById(`seg_acomp_k_${i}_${j-1}`)?.value || 0;

                            const a_type = at_el ? at_el.options[at_el.selectedIndex].text : FILL_VALUE;
                            dataRow.push(a_type, ak);
                        } else {
                            dataRow.push(FILL_VALUE, FILL_VALUE); // Pad accompaniment data with guiones
                        }
                    }
                } else {
                    // Pad the entire consultation block if the max is not reached
                    dataRow.push(FILL_VALUE, FILL_VALUE, FILL_VALUE); // Setting, P_Type, P_KM
                    for (let j=1; j<=max_acomp_seg; j++) {
                        dataRow.push(FILL_VALUE, FILL_VALUE); // A_Type, A_KM (x3)
                    }
                }
            }


            // 6. VISITA EXTRA ESPIROMETR√çA (FIJA)
            const misma_visita = document.querySelector('input[name="seg_misma_visita"]:checked')?.value === 'si';
            const espiro_done_seg = document.querySelector('input[name="seg_espiro_done"]:checked')?.value === 'si';
            const extra_needed = espiro_done_seg && !misma_visita;
            
            headerRow.push('S_EXTRA_SI_NO', 'S_EXTRA_P_TIPO', 'S_EXTRA_P_KM');

            if(extra_needed) {
                const et_el = document.getElementById('seg_extra_tipo');
                const ek = document.getElementById('seg_extra_km')?.value || 0;
                const e_type = et_el ? et_el.options[et_el.selectedIndex].text : FILL_VALUE;
                dataRow.push('Si', e_type, ek);
            } else {
                dataRow.push('No', FILL_VALUE, FILL_VALUE);
            }

            // --- CONVERSI√ìN FINAL Y ENV√çO ---
            
            // 1. Crear la l√≠nea CSV √∫nica (un string gigante separado por comas)
            // Usamos el mismo mapeo que antes para asegurar la integridad de los datos (escapando comillas y reemplazando guiones)
            const csvLine = dataRow.map(d => {
                let value = String(d || FILL_VALUE);
                // Escapa las comillas internas (doble comilla)
                return value.replace(/"/g, '""'); 
            }).join(',');

            // 2. Crear el encabezado (solo la primera vez)
            // El script de Apps Script solo maneja los datos de la l√≠nea, pero es muy √∫til enviar el encabezado
            // para que el Apps Script lo inserte si la hoja est√° vac√≠a.
            const headerLine = headerRow.join(',');


            // 3. Preparar los datos para el env√≠o (JSON)
            const dataToSend = {
                header: headerLine, // Env√≠a el encabezado para que el Apps Script lo use si es necesario
                line: csvLine        // La l√≠nea de datos real
            };

            // 4. ENV√çO V√çA FETCH (AJAX)
            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Necesario para evitar errores CORS en Google Apps Script
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataToSend),
            })
            .then(response => {
                // La respuesta siempre es "OK" debido al modo 'no-cors' y Apps Script,
                // pero podemos asumir √©xito.
                alert("‚úÖ Datos enviados y guardados correctamente en Google Sheets. ¬°Revisa tu hoja!");
                // Opcional: limpiar el formulario o redirigir
            })
            .catch(error => {
                console.error('Error al enviar los datos:', error);
                alert("‚ùå Error al guardar los datos. Revisa la URL y la configuraci√≥n de Apps Script.");
            });
        }
        // Inicializar
        window.onload = function() {
            renderSeguimientoInputs(); // Generar consultas iniciales
            updateInfo();
            // Ensure espirometry toggles are applied
            toggleDiagEspirometria();
            toggleSegEspirometria();
            // Initialize treatment devices with one default
            if (document.getElementById('trat_devices_container')) {
                // Ensure container cleared and add a default device
                document.getElementById('trat_devices_container').innerHTML = '';
                addTratDevice('17.59', 12);
            }
            // Initialize ingresos container if needed
            if (document.getElementById('ing_dias_container')) {
                document.getElementById('ing_dias_container').innerHTML = '';
            }
            calcular();
        };

    </script>
</body>
</html>